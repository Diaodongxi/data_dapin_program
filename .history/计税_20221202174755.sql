CREATE OR REPLACE PROCEDURE TAX_COUNT IS
BEGIN
    UPDATE GLA_GLIS_H_T02 T
    SET
        T.ONLNBL = T.LASTBL + (
            T.CRTSAM -T.DRTSAM
        ) / (
            1+ ( SELECT E.TAXRATE FROM TAX_RATE_SP E WHERE T.ITEMCD = E.ITEMCD )
        )
    WHERE
        T.SYSTID = '30101'
        AND T.ACCTDT = 20221101
        AND T.BRCHCD IN (
            SELECT B.BRCHCD FROM COM_BRCH B WHERE B.DETLTG = '1' START WITH B.BRCHCD IN (901020000, 901060000, 902010000, 903020000, 904020000, 905020000, 906020000, 907020000, 908020000, 909020000) CONNECT BY PRIOR B.BRCHCD = B.SPRRCD
        )
        AND ITEMCD IN (
            6011888,
            601107,
            601199,
            601202,
            60120102,
            601205,
            601209,
            601210,
            601299,
            60210601,
            60210502,
            60219901,
            60219902,
            60219904,
            60219905,
            60219906,
            602107,
            60210699,
            60219999,
            605105,
            606101,
            606102,
            606103,
            606199,
            610102,
            610103,
            610104,
            610105,
            610199,
            611106,
            611109,
            630101,
            630102,
            630103,
            630104,
            630105,
            630106,
            630107,
            630108,
            630110,
            60110501,
            60110502,
            60110503,
            60110504,
            6012010101,
            6012010102,
            60120401,
            60120301,
            60120402,
            60120399,
            6012070102,
            6012070202,
            60120602,
            6012070101,
            6012070201,
            60120601,
            60120801,
            60120802,
            60120803,
            60120804,
            60120899,
            60210101,
            60210102,
            60210103,
            6021020101,
            6021020102,
            6021020199,
            6021020201,
            6021020202,
            6021020203,
            6021020204,
            6021020205,
            6021020206,
            6021020207,
            6021020299,
            60210301,
            60210302,
            60210303,
            60210305,
            60210306,
            60210307,
            60210308,
            60210309,
            60210310,
            60210311,
            60210312,
            60210313,
            60210399,
            60210314,
            60210315,
            60210316,
            60210317,
            6021050101,
            6021050102,
            6021050301,
            6021050302,
            6021990301,
            60210405,
            60210407,
            60210408,
            6021020301,
            6021020302,
            6021020303,
            6021020304,
            6021020305,
            6021020306,
            6021020307,
            605101,
            605102,
            605103,
            605104,
            605199,
            61010101,
            61010102,
            61110101,
            61110102,
            61110199,
            601110,
            61110201,
            61110299,
            601111,
            61110301,
            61110399,
            611104,
            611105,
            611199,
            63010901,
            630111,
            630199,
            6021030401,
            6021030402,
            6021030403,
            60210401,
            60210402,
            60210403,
            60210404,
            60210406
        );
    COMMIT;
    UPDATE GLA_GLIS_H_T02 T
    SET
        T.ONLNBL = T.LASTBL + (
            T.CRTSAM -T.DRTSAM
        ) / (
            1+ ( SELECT E.TAXRATE FROM TAX_RATE_SP E WHERE T.ITEMCD = E.ITEMCD )
        )
    WHERE
        T.SYSTID = '30101'
        AND T.ACCTDT = 20221101
        AND T.ITEMCD IN (
            6011888,
            601107,
            601199,
            601202,
            60120102,
            601205,
            601209,
            601210,
            601299,
            60210601,
            60210502,
            60219901,
            60219902,
            60219904,
            60219905,
            60219906,
            602107,
            60210699,
            60219999,
            605105,
            606101,
            606102,
            606103,
            606199,
            610102,
            610103,
            610104,
            610105,
            610199,
            611106,
            611109,
            630101,
            630102,
            630103,
            630104,
            630105,
            630106,
            630107,
            630108,
            630110,
            60110501,
            60110502,
            60110503,
            60110504,
            6012010101,
            6012010102,
            60120401,
            60120301,
            60120402,
            60120399,
            6012070102,
            6012070202,
            60120602,
            6012070101,
            6012070201,
            60120601,
            60120801,
            60120802,
            60120803,
            60120804,
            60120899,
            60210101,
            60210102,
            60210103,
            6021020101,
            6021020102,
            6021020199,
            6021020201,
            6021020202,
            6021020203,
            6021020204,
            6021020205,
            6021020206,
            6021020207,
            6021020299,
            60210301,
            60210302,
            60210303,
            60210305,
            60210306,
            60210307,
            60210308,
            60210309,
            60210310,
            60210311,
            60210312,
            60210313,
            60210399,
            60210314,
            60210315,
            60210316,
            60210317,
            6021050101,
            6021050102,
            6021050301,
            6021050302,
            6021990301,
            60210405,
            60210407,
            60210408,
            6021020301,
            6021020302,
            6021020303,
            6021020304,
            6021020305,
            6021020306,
            6021020307,
            605101,
            605102,
            605103,
            605104,
            605199,
            61010101,
            61010102,
            61110101,
            61110102,
            61110199,
            601110,
            61110201,
            61110299,
            601111,
            61110301,
            61110399,
            611104,
            611105,
            611199,
            63010901,
            630111,
            630199,
            6021030401,
            6021030402,
            6021030403,
            60210401,
            60210402,
            60210403,
            60210404,
            60210406
        )
        AND T.BRCHCD NOT IN (
            SELECT B.BRCHCD FROM COM_BRCH B WHERE B.DETLTG = '1' START WITH B.BRCHCD IN (901020000, 901060000, 902010000, 903020000, 904020000, 905020000, 906020000, 907020000, 908020000, 909020000) CONNECT BY PRIOR B.BRCHCD = B.SPRRCD
        );
    COMMIT;

END TAX_COUNT;
 --CRTSAM	NUMBER(18,2)	Y	0		贷方本期发生额
 --DRTSAM	NUMBER(18,2)	Y	0		借方本期发生额
 --LASTBL  上期余额

 /*SELECT ITEMCD FROM GLA_GLIS_H_T02 WHERE ITEMCD NOT IN (
 SELECT ITEMCD FROM GLA_GLIS_H_T02 WHERE SYSTID = '30101' AND ITEMCD IN (...))*/